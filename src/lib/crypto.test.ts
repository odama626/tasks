import { test, expect } from 'vitest';
import * as aesjs from 'aes-js';
import { bytesToBase64 } from 'byte-base64';
import {
	createPayloadSignature,
	createSymmKey,
	decryptWithKey,
	encryptWithKey,
	exportSymmKey,
	exportUserKeypair,
	generateEncryptionKeypair,
	importSymmKey,
	importEncryptionKeyPair,
	login,
	generateSigningKeypair,
	importSigningKeyPair,
	verifySignature
} from './crypto';
import { encode, decode } from '@msgpack/msgpack';

const encryptionKey = {
	privateKeyHash:
		'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',
	publicKey: {
		alg: 'RSA-OAEP-512',
		e: 'AQAB',
		ext: true,
		key_ops: ['encrypt'],
		kty: 'RSA',
		n: 'lplhoyt6qCEvYIfCwnRx2UbWrCx3npA8ZCHXyrGzs61gRhbITlGwCWlWK8teHGiE7jIt_bj2diFtwErNstg5zUHWuOSEkI5b0R3Q6JdcT2igvl-qWnRcCv5ty_6nGkPJ-DzPpD4ixLtAjk6aVGg8sTKR3xJmZSVLRTazvliAbKIYi9iISESX4XlDX7xBIqLf1xpFeQYDkpb18Y0OREmR0PyAEaSAu5puI3Q_d-WD5-cczvchQJqAauk2f2GWSqKV2As8QLsbAuGJ_d3IgnvjMaQyGFeua_LfgogsPx9NAyo3RHWvODyUOYOD1BEi7UExyimcgCDLDTfvHp-nVSSpwdJOKp3Mq2UsK3vOrgdBspz2p5Jlfa31qZZWkLPRJ6flrlP_bPGgPBT1fv9hrXhH2K9H5ricZkegs0ZUWDVC97aT6AvqiU7M8hCrl-Goa_Aw4EcatQCjc4_KBinNHISVul3jXiKuKW4g1beo0QfAgDVkyy4vAvhKAnzShsCQbS4OMer_xBzGRAy0Jzr73k7LBobm0em7jhlfzGzU9xly8_s8RweZ8a4g9Wlkxv8zyqPTdjBjKIxnsgKWi9flyL29Bb7hF9OWebKN7nRxUW077cuZ9aObmBME6fdnNClNaHOSgHpbudej4yLEmrdkQB-hqkhmXnQF1x21348IV30z2rM'
	}
};
const signingKey = {
	privateKeyHash:
		'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',
	publicKey: {
		alg: 'RS512',
		e: 'AQAB',
		ext: true,
		key_ops: ['verify'],
		kty: 'RSA',
		n: 'jcgAXfPQzm3A5vIWzGfEB1BKilHN7Udn6c7n6-R_nKDVOSLLXwi7iPuSSabfr-enr8nAa-sjOYu3ddgZiCW5AXNveh57vLUDeEZhsPvDHvdqWFTcDgc8aN3k0NsXTKp5jD3wZiXEr0sSX0rcgVLiHUaCRKvO9AR3Dg1s6cpH1CN00AdQnTjydXwRnJHV_if-P1OZK_-2sfDDR6nlvqNLqK39lFvA_btjeL7yP-jrJdqWFu-cxe1i41WMiHZlJu6D0wSWga3XLd4BGhE8tOO_jAk7xN6gjaztrpuZC-S3-unlBtvGgBD9nvdcXrdwsR2ttbjDpNg2A3Z2rMx6y6zl_jlxmZ4bc_RejZ7IZJlkTFPOp1aenIwYW8zVFdNKtplpGynTKdBkK80JYM8Dht633DTL5WpfNxBUR2Y6ECWe_j1E7sJjdWeadMSxgzA1ClV5laQaEYsU7N5tRG3IydN2gB050a0vCh2MmCIVVjEWVBtVAuSbM0-Oix8cxEvWYLpwKwon1Zunmti3YgzZ_Cpdmfcd1sf1Hb16iwohyMl9BIJfTC0t3A-6FwKw4GX1yVqRbnkt4dKYZfA6yMDbT5J-WdSaYDBtG42poJko-RVNNT6-vsP9XurHQjxk1EOUvg6sEfIIAgs4s_EAecdzJ9fN8AYcsMUQ8ysdDnE6MgeUghc'
	}
};

const salt = new Uint32Array([
	1370921999, 362000921, 1401009754, 4262136113, 2710957243, 1794858990, 2125776193, 2181252641,
	3689540781, 1877738531, 3132070000, 1919055809, 1447966125, 2608881379, 3006453550, 792443570
]);

test('generate keys', async () => {
	const password = 'test password';
	const signingKeys = await generateSigningKeypair();
	const encryptionKeys = await generateEncryptionKeypair();

	expect(signingKeys).toBeTruthy();
	expect(encryptionKeys).toBeTruthy();
});

test('import export encryption keypair with password', async () => {
	const password = 'test password';
	const imported = await importEncryptionKeyPair(encryptionKey, password, salt);
	const exported = await exportUserKeypair(imported, password, salt);
	expect(exported).toStrictEqual(encryptionKey);
});

test('import export signing keypair with password', async () => {
	const password = 'test password';
	const imported = await importSigningKeyPair(signingKey, password, salt);
	const exported = await exportUserKeypair(imported, password, salt);
	expect(exported).toStrictEqual(signingKey);
});

test('register', async () => {
	const password = 'test password';
	const keyPair = await generateEncryptionKeypair();
	const exported = await exportUserKeypair(keyPair, password, salt);
	expect(exported).toBeTruthy();
});

test(`login`, async () => {
	const password = 'test password';
	const keyPair = await login(encryptionKey, signingKey, password, salt);
	expect(keyPair).toBeTruthy();

	await expect(login(encryptionKey, signingKey, 'wrong password', salt)).rejects.toThrow();
});

test('page key', async () => {
	const key = await createSymmKey();

	const payload = aesjs.utils.utf8.toBytes('Test');
	const encrypted = encryptWithKey(key, payload);
	const output = decryptWithKey(key, encrypted);

	const result = aesjs.utils.utf8.fromBytes(output);

	expect(result).toBe('Test');
});

test('page key import export', async () => {
	const password = 'test password';
	const keys = await login(encryptionKey, signingKey, password, salt);

	const key = await createSymmKey();

	const exported = await exportSymmKey(keys.encryptionKey, key);

	// store exported key in db

	const imported = new Uint8Array(await importSymmKey(keys.encryptionKey, exported));

	// key loaded from db

	expect(imported).toStrictEqual(key);
});

test('create signature', async () => {
	const password = 'test password';
	const keys = await login(encryptionKey, signingKey, password, salt);

	const data = {
		name: 'John Doe',
		publicKey: encryptionKey.publicKey,
		privateKeyHashed: encryptionKey.privateKeyHash
	};

	const payload = encode(data);

	expect(bytesToBase64(payload)).toMatchInlineSnapshot(
		`"g6RuYW1lqEpvaG4gRG9lqXB1YmxpY0tleYajYWxnrFJTQS1PQUVQLTUxMqFlpEFRQUKjZXh0w6drZXlfb3BzkadlbmNyeXB0o2t0eaNSU0GhbtoCq2xwbGhveXQ2cUNFdllJZkN3blJ4MlViV3JDeDNucEE4WkNIWHlyR3pzNjFnUmhiSVRsR3dDV2xXSzh0ZUhHaUU3akl0X2JqMmRpRnR3RXJOc3RnNXpVSFd1T1NFa0k1YjBSM1E2SmRjVDJpZ3ZsLXFXblJjQ3Y1dHlfNm5Ha1BKLUR6UHBENGl4THRBams2YVZHZzhzVEtSM3hKbVpTVkxSVGF6dmxpQWJLSVlpOWlJU0VTWDRYbERYN3hCSXFMZjF4cEZlUVlEa3BiMThZME9SRW1SMFB5QUVhU0F1NXB1STNRX2QtV0Q1LWNjenZjaFFKcUFhdWsyZjJHV1NxS1YyQXM4UUxzYkF1R0pfZDNJZ252ak1hUXlHRmV1YV9MZmdvZ3NQeDlOQXlvM1JIV3ZPRHlVT1lPRDFCRWk3VUV4eWltY2dDRExEVGZ2SHAtblZTU3B3ZEpPS3AzTXEyVXNLM3ZPcmdkQnNwejJwNUpsZmEzMXFaWldrTFBSSjZmbHJsUF9iUEdnUEJUMWZ2OWhyWGhIMks5SDVyaWNaa2VnczBaVVdEVkM5N2FUNkF2cWlVN004aENybC1Hb2FfQXc0RWNhdFFDamM0X0tCaW5OSElTVnVsM2pYaUt1S1c0ZzFiZW8wUWZBZ0RWa3l5NHZBdmhLQW56U2hzQ1FiUzRPTWVyX3hCekdSQXkwSnpyNzNrN0xCb2JtMGVtN2pobGZ6R3pVOXhseThfczhSd2VaOGE0ZzlXbGt4djh6eXFQVGRqQmpLSXhuc2dLV2k5Zmx5TDI5QmI3aEY5T1dlYktON25SeFVXMDc3Y3VaOWFPYm1CTUU2ZmRuTkNsTmFIT1NnSHBidWRlajR5TEVtcmRrUUItaHFraG1YblFGMXgyMTM0OElWMzB6MnJNsHByaXZhdGVLZXlIYXNoZWTaDGBVTHZ5T00wdUR6Um8yZndBRWhvV3hHK0pZOE1rYUhxUWNTYlJ1NjVqeFZTOUdGVkVheG9UQ0ZmNFdvVzcrNlVBQzFCQ2w3ejU1Q3ZNQlI3SjFHRllkMlhJTzQza05WMkY5dFNNWVphUG1yakxjenY5YlRJVWUxK215MHBWNWJhYlE1NGt1UFBlN3FlK3lzb0J5dnJmZllBdU5GeDArTUh5WXFVbFJSWnRnT0M2U0M3alZ1L3pzWElHWkx2V25nNXV5M2R3ZzJzYkRHUEtPS29EVllWbmNiSkhEc256cDFYUGhYQUVqV041SEJuVzB6ODRoOHJFRzNkc0VIekpaRSs5YXJEK1lKQUtLanFnY2NWdExPMEFZWnlGYVVMZ0t6eXRMYWFWMWxjT2lRZVA5YlE2eFc5SWNTOVlEL1dHUWNSM3F0cDVTZGJRZ0Jtb2JwNzhwOUo3N1ZBbXdjbFFYWDAwQ09ZSnN0TjNDRFgzYnFkdWxMdk53SlJZYWN6YkpxL2U5U0kwa3FMTkNqR1Ntd2F3UGwxV0FuMXNZMk9oNXJqYzNUcURYT2xPcTg4RGJtam1lamU3Ti9qZ3RFSnduY2twZFVBLzV5MEg0OEMvUWFKaDlSeHhpYUozcnBiS1hnSm9kUFVQNDVVcFJ6TlJ4elBVZWNiSlgyODY0MzBYZEdOKzFoT2RmZUFHUkNwSWwzR21HSDJTdm9MNzRDS3RDUWxXUHFaZStEUGhZOE5LUGR4WWF4QTcxSEZ5bWRQaGZPWXFUL3V3Z0dXRU15bW42Q2ZRd2FUOVI4bDMxM0t5Kzd5U012MmRMWDBWNEdNRDJnbkxLNlZLS3BQR0RqSm51V3YrWmp4dWRNQVpnSG5ScU83YUhnZ1Vrb1dyNnlIMGhZWWt0L2psamU1amNoVlF0b3VUMklYek5pdVFQbDVnODNydzJkOTE4dUVrQmI5MzFxUGRIYTZDU0cvSHZza0dWektlVnRqL2VNMzRWRjBIbHhpVWorYmh2QUF5N2xzL0dNMjczZzhkYzhoeVVlcnZaZTVwSGYrK1VzRjZZa2NYNzFyNHNoNEpUbnkrRVRJMTlYVnZXdEkwLzdVR0lPeUpXVmxkSXBVR0lqZ05mbEJSTmdXangwNC9FQ1RsNmdYNE1TZzJPRm9XcFJYRkxNd0VaZlN2SERMc2owbnBwb2xLTmhSci9DUWZKK3VPMGFISTUxZ0NjT2laL0pMYmt3dFB4SXJrTHlORzF5YlFRVXQ5NS9POHh6ZjBBbm5pUHY1cnZmZTIweWlSSmRRY2FwREFQVzljcGpjcmU2allXdGc4V2x0TmhUR1NrV0F2d0NXdktKQ0QrWkgyL3Urd1BxL0hDa24vTUs0RnJId3B6M3FvQnBwa0Izdkw4bVR3V2h0Y0tBbWpGYUYwNTVqUlpLcE9vZ0s1YWdPOWozc3JMbjh0Sm5EYlk4TVB2clJoTXZ4RjJsU3d2UFd0Z05iWE4wdzlVMlVXMm9mdlRMbmpYTlUzd3BNVU1hdnUwTFdUcHA3T0I3dWNzTHVhUGpsbUovOGxYTVJEQ2tIL2F5aFVDUW1ER3V0UXRjbmVpMW9PaDRralJrQnhFQnNhNWs5VFEzZGNJYmlQM3BmTlFXU3RMcW5PL0l5UENaZXNuMHVDbFJCOGV5WnFlWHhlWTdQNzl4S2tUbk16cDU2OFhkNk80OFIxdnVISjhmZElVU1VEbkl3citkQWtkYzNzZGs4TFJ0K0hFS05GSHdRUE51Rmd4Mm1HUTNWQlozdkJ1RC81YWRaRTZZZGFDcUMrM0dId3pqQnBiaEtZZlA0UGZSRnNiSG1OTE11b3h1TGF3djhEdE5IZnNLY2ovVWc2aVBRMnNSUkkzVlU3eTR6NzNvV3ZzRGt3T0kvdDhpanZleVRzRXdpT0xWMFgvc0dDenlsU0xOdnZsZERLQUFDeFlxWERwR0tyTTg0clJvNGZ2T09kazBNK0NXOTZTbUYwNnNXTUEzRTRXTTc2ajlMLzdHSmFBblZlbUN0WVNialRKcUd6UkxKczlsSnU5L2xsRzkySXUvSytOdGV1Q01GS3pFSXlOQitVY3MxdFBFa056RzdqTFpVSWJqUG1oVVNmWlVhNWFGeVlqZFY5eXEwTlhMZHlPRml6Z1I0N0x3M0hiMDNVUHZ5d3JyajdMSWhXM1o0TEtFbUVldmc1Y1lrY0VlNWMxaWJSZXlnQTRCOUp1UU5QUUR6d3NMVzdiM1VPY0JRM2F6cHhNWlNjSkIyMXlnOElnVWZMZ09JZ0xqNjRsa1RUdFN5TGcxMUYxbHBKdG0wanVXSFJ0SFI3Sng4RUFpbE96eHBwNkpvaHZ5cVVXTUtVenFmZ0dGSTlXUzNOTEs0SmVGYk13NExZR0lXQWFvL2U4NEJ2K3lWQWErVkJBYkxlRlZTTmRJdjlmVkcyUVh1alZNVlFXSis2NWdlQnNlQzRTYkFaakFld3VwZmFSUHpKMW9WbTFBYlpCYVl3U2xCZ3o5Sy91QUk0RHZuNE1LQUVDN2VEdHVPOUhBTVJSdndoL1F1dEtjVSt2cFdPM3hOcEpIVHI1Y0xRZGtJNDlPVEZod0FNSkdjbkZiZVJEYTVPb1FmUnFrYmxTMWxqT0dhNENaVVQxMlNrS09nenhFc0ZwdjM0TjcxbjZhUUV1TW9UMXdkNXVGUXpoTm8vYm1UaE9lY3RqYUlwSy9kUUpydW4wK3A3VUREMW45OTkzUUFkd1J0bmlJOFYwTGd6V2FOckV4WlBNQTRIb1Z6d0daQnRNdXpDWmpUOTR4MUtINzVvbWhXN3ZpRU1KbFovZGFIakppZ3BkdVU5eStJb0c4M1lITTY4dzBVdXc1d0l5N2Y5Mm44T05NdlB0eTB6di9MWWcwUXBVL1JZM0hTcmlkMnpaRWVNZ2gxNUpIVDNYSnZFMGdzWFkrMGREUU50R0pZVkVnYU5LU2tmb2dUSGdLNFY2dkNSbENYTlJ6VUdoYzNab01mdTZPc21HQXQ4cDVzSGRrQkVDMXpSQTVsV29RSlRjdWdVS01mbFBhT0lRN3RNQ1NoRTk0aWtyS2VMeXpVbHdsRStNSUppK0wwV0g3R1FFUTMvdmo5d0VxR2prWGg0MUJVQ2JRWGJoZlYreWkyNlBudHEvY3Jqb0VQNGdkYzR5YndPMTNRK3ZEQS90eTE5djdYR3djc002cnc1dWNLRXNYQzUrYitJaEFRU1cwV09QbmR3aXd0clBCb3Qyb3JlbG9mRHFabFpxbnM2ZDRWQ0lRaTVURisveXkwMGhMbUkvL0VqYlFaZFpsNzFCMFBjbmdzTThYOThrR0RkaXZUelM4T3hYWHhxVllCZWMwSXZnTk9XZXJBQ2tZUElENmh0OHBUak5oRXJjdzN1UUdZVkdGUWtIZXRUYmRCRVNMRDVmWnRseE4yL1BRQms5L3g5blFnczZ3T3k4cytTUzExTjFxNzdjdXZQZk9NYXZ3ZjJ1b0VpamZXOGJzK05xNkpnWW9kdzdJMDBVdklqM3RlL3RSbkNHZmNDYnRHeU11Ynk1dlh2YUtTVlNuL2tTSEdHOVdUUlBBbWhsYSs1RTBRZVluR0VySXpzNDh5ZUV6QmtsR0pkbjd3dFAzaks4UWVhekc2OENGSlQyVDZIQlVwQ3FTWXoweVJseWt3VlVaVE5Oa2REMVl2T0s5M3hkTnhVTG13eU9kWEpPZ1gxdFhxR1E1LzdRM2lLUFh2OVdVOWZoWkprWGZoQng0Z1hmNmxMbnoxcFdCZ3FUbnlBYW5DNGh6YmU0SkFsS2EwbjNVZjl6T3NhVk9oTU5qMFYvZ0xiYVVWVG5wdTV6NXlUaWZWMUViWEF1VmdPUlNzcTY2WXYwWWRmdDNKcUNaeVgrR3dyOHdOTTJ1bWNUNzQ1YlM3QnlWQ3Z6cXg2ZHdiNkdBa3pUc0pMNVJoaFg4eHFBRGtBQ2RyaFBveXdHT1pmTzJkenFTUFBwOXVrYkEzY3U2TDhHdzdWRHlwWEo5MnVqeCtDZVV3Q3F2dFhFQ1A0WlUrY2xNU1Fpd2pGcHQyK3BoY2YyS1A2SWx0d0dONEZHTzdmT3dnR0kzTVVuN29VZUxDOUppekNDVlJJdzVqMjUxMm04L2RNUDJSM2RBditZR0t0TmxNRU0vcWpKWGdhaEpPaGQ0aXg5Qy8zNDcrNUpGRFlQaVFxdEF5SDJDZTgrcFJRK2VaKzY4ND0="`
	);

	const signature = await createPayloadSignature(keys.signingKey, payload);
	expect(signature).toMatchInlineSnapshot(
		`"IbrXD/ENxXNAmwCEXJEcNTGZOqt64af4u72uhkBgB5evAAOx1H4cCJ3EGol0AYdKhUI2GUsrCjcLFwKgq10zdjlSc527BhlVVQraH2gTL/4Ivp5X9hfQt75+EfTFLTBh7VW7P3ODXox2c1h3CENjQrjAWJ08URowe/Iamf4XnVPuuAQAAGhKeAXNlmjJvs5jpQW0m1PfWP9WbhBj3/IvVSam1dFTpDsiqtiXu0ByIKSPzG+dqpMqeetsf1GtEZxmU0wGhlrP2hJ9XuvboQok5XfGu9o1R78VxV9hoyPG/Caz+gnl7amvSr56uYE83ang8f7coRKlwOO0E++FWOTHTFqyL09cdMeZldsR5tpPq5DBzERe77A7VvX2hnTBg3Q61+oflm0LN8WOIaDond3o3ZSdsWVpsfmLfP8dSNm/xhhhj/ZsROjbagdgg+RAqh5M82yjmaqGP/3yXTe0Z0tDBGmgfo5dpv3uAriVZL/8C20nnzmIRPUwRY2GZJ/8ZeIhhdHQD7+/VvjrDXazG6SPnb2koJRc5vSE5HShAaqOy17qJvpS04ng7zqKp1ITK4bDoW4NjoCw3i2sOqudYmACqCEs81XG2lTxd2yoH5uzP33nsXN1TqQxXgT49nLN+zgwnICDe6RP61Z9Ip7jEtSy7MzyHz8eUoaTXfCOAG1Jet4="`
	);

	const valid = await verifySignature(keys.signingKey, payload, signature);

	expect(valid).toBe(true);
	const result = decode(payload);
	expect(result).toStrictEqual(data);
});
